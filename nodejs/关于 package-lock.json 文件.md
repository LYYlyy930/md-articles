# 关于 package-lock.json

忘记什么开始，发现自己的 node 项目里都有一个名叫 **package-lock.json** 的文件。刚开始没在意，后来遇到一个问题，就是这个文件到底需不需要添加进版本控制。

npm 官网有这么一句话：

```
This file is intended to be committed into source repositories, 

and serves various purposes:
```

看来官网是建议我们添加的，但是很快发现网上大家对这个文件的存在褒贬不一，我们来看看这个文件到底是干什么的，然后大家自行决定需不需要它。

**npm 5** 推出了 **package-lock.json**。使用语义化版本规范，去描述对于其他包的直接依赖。**package.json** 只是描述了第一层依赖，也就是我们项目所直接使用的第三方模块的依赖。而 **package-lock.json** 是完整描述了整个项目的依赖树，包含了所有包及其解析的版本（事实上 **package-lock.json** 文件是根据 **node_modules** 的文件目录生成的）。也就是说该文件的存在确保了我们的项目在任何环境下都能保持一致的全部依赖。

**npm** 原本也是有类似的功能的 ———— **shrinkwrap**

**package-lock** 跟 **shrinkwrap** 是存在着千丝万缕的联系。

- **package-lock** 跟 **shrinkwrap** 有着一致的文件结构
- 他们都是是为了锁住项目依赖的版本

区别在于

#### shrinkwrap

- 使用 **npm shrinkwrap** 命令来创建、更新
- 它拥有更高的优先级，也就是说与 **package-lock.json** 共存时，**npm** 将忽略 **package-lock.json** 文件（只是用 **npm** 命令操作的时候，这种情况不会发生）
- 可以发布，他描述的是特定时间点的版本依赖。

#### package-lock.json

- 安装模块操作（改变 **node_modules** 文件夹内容）会生成或更新 **package-lock.json** 文件（除非已经存在 **shrinkwrap**）
- 优先级比 **shrinkwrap** 低
- 发布的模块不会包含 **package-lock.json** 文件

#### 小彩蛋

- 对于已有 **package-lock.json** 的目录运行 **npm shrinkwrap** 命令时，**npm** 会把 **package-lock.json** 重命名为 **npm-shrinkwrap.json**
- 若一些人为操作不当使得两个文件同时存在时，**package-lock.json** 将被 **npm** 忽略
- 每次 **npm install/uninstall/update** 都會去更新 **package-lock.json **
- **npm 5** 之后使用**npm install xxx**命令安装模块时，不再需要**--save**选项，会自动将模块依赖信息保存到 **package.json** 文件
- 如果手动修改了 **package.json** 文件中已有模块的版本，直接执行**npm install**不会安装新指定的版本，只能通过**npm install xxx@yy**更新，然后它会自动更新 **package-lock.json** 文件
- 直接执行**npm install**时，如果不存在 **package-lock.json** 文件，它会根据安装模块后的 **node_modules** 目录结构来创建；如果已经存在 **package-lock.json** 文件，则它只会根据 **package-lock.json** 文件指定的结构来下载模块，并不会理会 **package.json** 文件

#### 禁用

在当前项目禁用 **package-lock.json**

```
echo 'package-lock=false' >> .npmrc
echo 'package-lock.json' >> .gitignore
```

在所有项目禁用 package-lock.json

```
npm config set package-lock false
```

## 总结

这么看下来，我们在任何时候都应该避免手动修改 **package.json** 中的依赖信息。

其实像 **npm** 这样可以很轻易的发布新版本的模块管理器来说，版本锁定势在必行，除非你准备好了不断的处理各种版本不兼容的问题。所以如果你在协同开发生产项目，那我建议你还是把它加入版本控制中，如果你是在写一个开源工具，那么加不加其实都无所谓。

并且因为 **package-lock.json** 文件中已经记录了整个 **node_modules** 文件夹的树状结构，甚至连模块的下载地址都记录了，再重新安装的时候只需要直接下载文件即可，所以有了它重新安装模块的速度会快很多，这里感觉很像 **yarn.lock** 文件。**npm 5** 之后，它跟 **yarn** 的差距又变小了，但是 **yarn** 的多线程安装、缓存、漂亮简洁的输出、更好理解的语义……

好吧，目前来看，我还是建议使用 **yarn**。


## 关于 Porco

Wechat: porco5555

Gmail:  zhangporco@gmail.com